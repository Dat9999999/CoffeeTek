# --- Stage 1: Build ---
    FROM node:22-alpine AS builder
    RUN corepack enable
    WORKDIR /app
    
    # Copy config files first
    COPY package.json pnpm-lock.yaml .npmrc ./ 
    
    # Install dependencies (Thanks to .npmrc, these are now REAL files, not symlinks)
    RUN pnpm install --frozen-lockfile
    
    COPY prisma ./prisma
    RUN pnpm exec prisma generate
    
    COPY . .
    RUN pnpm run build
    RUN pnpm exec tsc --project tsconfig.seed.json
    
    # Remove devDependencies to keep image small
    # Since we use node-linker=hoisted, this safely removes dev files
    RUN pnpm prune --prod
    
    # --- Stage 2: Run ---
    FROM node:22-alpine
    WORKDIR /app
    RUN corepack enable
    
    # 1. Install Prisma CLI globally (matching your version)
    RUN npm install -g prisma@6.15.0
    
    # 2. Copy the "hoisted" (flat) node_modules - safe to copy now!
    COPY --from=builder /app/node_modules ./node_modules
    COPY --from=builder /app/prisma ./prisma
    COPY --from=builder /app/dist ./dist
    COPY --from=builder /app/package.json ./package.json
    
    EXPOSE 3001
    
    CMD ["sh", "-c", "prisma migrate deploy && prisma db seed && node dist/main.js"]